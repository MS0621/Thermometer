#include "mbed.h"
#include "Adafruit_SSD1306.h"
#include <cmath>
#include "Serial.h"

DigitalOut myled_R(LED1);
I2C i2c(D4, D5);
I2C i2c_oled(D12, A6);
DigitalIn myswitch(D3);
Timer t1;
Serial pc(USBTX, USBRX, 9600);
Serial bt(D1, D0, 9600); // HC-06 tx, rx
Adafruit_SSD1306_I2c myOled(i2c_oled, A0, 0x78, 64, 128);

static unsigned char figure[] = {
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x40, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0xF8, 0xC8, 0x08, 0x08, 0x08,
0x08, 0xD8, 0xF8, 0x38, 0x09, 0x09, 0x89, 0xE1, 0xF1, 0x99, 0xF9, 0xF9, 0x01, 0x01, 0x81, 0xF9,
0x79, 0x89, 0xC9, 0x79, 0x79, 0x11, 0xC1, 0xF9, 0x79, 0xC9, 0xE1, 0x31, 0x19, 0x09, 0x01, 0x01,
0x01, 0x01, 0x81, 0xE1, 0xF9, 0x7D, 0x1F, 0x0F, 0x07, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x60, 0x86, 0xE6, 0xE6, 0x87, 0x63, 0x80, 0xE0, 0x20,
0xA6, 0xE7, 0xC1, 0x60, 0x06, 0xC7, 0x23, 0x41, 0xE1, 0x21, 0x07, 0xA7, 0xE0, 0x24, 0x87, 0xE3,
0xA0, 0x67, 0x07, 0xE0, 0x00, 0xE6, 0x67, 0x23, 0x00, 0x63, 0xE7, 0x27, 0x00, 0xC0, 0x60, 0x38,
0x1C, 0x07, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x01, 0x00, 0x01, 0x01, 0x01,
0x01, 0x00, 0x01, 0x01, 0x01, 0x01, 0x00, 0x01, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00,
0x01, 0x00, 0x01, 0x00, 0x01, 0x01, 0x01, 0x00, 0x01, 0x01, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

bool getTemp(float *temp_val)
{
    char ch1, ch2;
    char cmd[2];
    cmd[0] = 0x07;
    cmd[1] = 0;
    i2c.stop();
    wait_us(5);
    ch1 = i2c.write(0xb4, cmd, 1, true);
    if (ch1 != 0)
    {
        return false;
    }
    ch2 = i2c.read(0xb5, cmd, 2);
    if (ch2 != 0)
    {
        return false;
    }
    wait_us(5);
    *temp_val = ((((cmd[1] & 0x007f) << 8) + cmd[0]) * 0.02) - 273.15;
    return true;
}

bool getTempAmbient(float *temp_val)
{
    char ch1, ch2;
    char cmd[2];
    cmd[0] = 0x06;
    cmd[1] = 0;
    i2c.stop();
    wait_us(5);
    ch1 = i2c.write(0xb4, cmd, 1, true);
    if (ch1 != 0)
    {
        return false;
    }
    ch2 = i2c.read(0xb5, cmd, 2);
    if (ch2 != 0)
    {
        return false;
    }
    wait_us(5);
    *temp_val = ((((cmd[1] & 0x007f) << 8) + cmd[0]) * 0.02) - 273.15;
    return true;
}

bool getRawIR(int16_t *ir_val)
{
    char ch1, ch2;
    char cmd[2];
    uint16_t temp;
    cmd[0] = 0x04;
    cmd[1] = 0;
    i2c.stop();
    wait_us(5);
    ch1 = i2c.write(0xb4, cmd, 1, true);
    if (ch1 != 0)
    {
        return false;
    }
    ch2 = i2c.read(0xb5, cmd, 2);
    if (ch2 != 0)
    {
        return false;
    }
    wait_us(5);
    temp = (uint16_t)((cmd[1] << 8) | cmd[0]);
    if (temp & 0x8000)
        *ir_val = ~((int16_t)(temp & 0x7fff)) + 1;
    else
        *ir_val = (int16_t)temp;
    return true;
}

void myOled_config()
{
    myOled.begin();
    myOled.setTextCursor(0, 0);
    myOled.clearDisplay();
    myOled.drawBitmap(32, 0, figure, 64, 64, WHITE);
    myOled.setTextCursor(0, 0);
    myOled.printf("Press\n");
    myOled.printf("Button\n");
    myOled.display();
}

int main()
{
    float temp = 0.0;
    float amb_temp = 0.0;
    int16_t ir_data = 0;
    float final_temp = 0.0;
    float final_amb_temp = 0.0;
    float final = 0.0;
    float final_ir_data = 0.0;
    int num = 0;

    pc.printf("===============Hello world===============\n\r");
    myOled_config();
    myswitch.mode(PullDown);

    while (1)
    {
        myled_R = !myled_R;

        if (myswitch.read())
        {
            t1.start();
            num = 0;
            final_temp = 0.0;
            final_amb_temp = 0.0;
            final = 0.0;
            final_ir_data = 0;

            while (t1.read() <= 2)
            {
                myOled.setTextCursor(0, 54);
                myOled.clearDisplay();
                myOled.printf("Charging....\n", final_temp / num);
                myOled.display();

                if (getTemp(&temp) & getTempAmbient(&amb_temp) & getRawIR(&ir_data))
                {
                    final_temp = final_temp + temp;
                    final_amb_temp = final_amb_temp + amb_temp;
                    final_ir_data = final_ir_data + ir_data;
                    num = num + 1;
                }
            }

            float final = final_amb_temp + 0.073026248 * final_ir_data + 2.299303456;
            float final_rounded = round(final / num * 100) / 100;

            myOled.setTextCursor(10, 5);
            myOled.clearDisplay();
            myOled.drawRect(0, 0, 128, 64, WHITE);
            myOled.drawRect(1, 1, 126, 62, WHITE);
            myOled.printf("Surf Tem: %5.2f\n", final_temp / num);
            myOled.printf("Amb Temp: %5.2f\n", final_amb_temp / num);
            myOled.printf("IR_data: %5.2f\n", final_ir_data / num);
            myOled.printf("Final Temp: %5.1f\n", final_rounded + 1.6);
            myOled.display();
            t1.stop();
            t1.reset();
        }
    }
}